import { Directive, Input, Output, EventEmitter, ElementRef, } from '@angular/core';
import { VgApiService, } from '@videogular/ngx-videogular/core';
import * as i0 from "@angular/core";
import * as i1 from "@videogular/ngx-videogular/core";
export class VgHlsDirective {
    constructor(ref, API) {
        this.ref = ref;
        this.API = API;
        this.vgHlsHeaders = {};
        this.onGetBitrates = new EventEmitter();
        this.subscriptions = [];
    }
    ngOnInit() {
        if (this.API.isPlayerReady) {
            this.onPlayerReady();
        }
        else {
            this.subscriptions.push(this.API.playerReadyEvent.subscribe(() => this.onPlayerReady()));
        }
    }
    onPlayerReady() {
        this.crossorigin = this.ref.nativeElement.getAttribute('crossorigin');
        this.preload = this.ref.nativeElement.getAttribute('preload') !== 'none';
        this.vgFor = this.ref.nativeElement.getAttribute('vgFor');
        if (this.vgFor) {
            this.target = this.API.getMediaById(this.vgFor);
        }
        else {
            this.target = this.API.getDefaultMedia();
        }
        this.config = {
            autoStartLoad: this.preload,
        };
        // @ts-ignore
        this.config.xhrSetup = (xhr) => {
            // Send cookies
            if (this.crossorigin === 'use-credentials') {
                xhr.withCredentials = true;
            }
            for (const key of Object.keys(this.vgHlsHeaders)) {
                xhr.setRequestHeader(key, this.vgHlsHeaders[key]);
            }
        };
        this.createPlayer();
        if (!this.preload) {
            this.subscriptions.push(this.API.subscriptions.play.subscribe(() => {
                if (this.hls) {
                    this.hls.startLoad(0);
                }
            }));
        }
    }
    ngOnChanges(changes) {
        if (changes.vgHls?.currentValue) {
            this.createPlayer();
        }
        else if (changes.vgHlsHeaders && changes.vgHlsHeaders.currentValue) {
            // Do nothing. We don't want to create a or destroy a player if the headers change.
        }
        else {
            this.destroyPlayer();
        }
    }
    createPlayer() {
        if (this.hls) {
            this.destroyPlayer();
        }
        // It's a HLS source
        if (this.vgHls &&
            this.vgHls.indexOf('m3u8') > -1 &&
            Hls.isSupported() &&
            this.API.isPlayerReady) {
            const video = this.ref.nativeElement;
            this.hls = new Hls(this.config);
            // @ts-ignore
            this.hls.on(Hls.Events.MANIFEST_PARSED, (_event, data) => {
                const videoList = [];
                videoList.push({
                    qualityIndex: 0,
                    width: 0,
                    height: 0,
                    bitrate: 0,
                    mediaType: 'video',
                    label: 'AUTO',
                });
                data.levels.forEach((item, index) => {
                    videoList.push({
                        qualityIndex: ++index,
                        width: item.width,
                        height: item.height,
                        bitrate: item.bitrate,
                        mediaType: 'video',
                        label: item.name,
                    });
                });
                this.onGetBitrates.emit(videoList);
            });
            // @ts-ignore
            this.hls.on(Hls.Events.LEVEL_LOADED, (_event, data) => {
                this.target.isLive = data.details.live;
            });
            this.hls.loadSource(this.vgHls);
            this.hls.attachMedia(video);
        }
        else {
            if (this.target && !!this.target.pause) {
                this.target.pause();
                this.target.seekTime(0);
                this.ref.nativeElement.src = this.vgHls;
            }
        }
    }
    setBitrate(bitrate) {
        if (this.hls) {
            this.hls.nextLevel = bitrate.qualityIndex - 1;
        }
    }
    destroyPlayer() {
        if (this.hls) {
            this.hls.destroy();
            this.hls = null;
        }
    }
    ngOnDestroy() {
        this.subscriptions.forEach((s) => s.unsubscribe());
        this.destroyPlayer();
        delete this.hls;
    }
}
/** @nocollapse */ /** @nocollapse */ VgHlsDirective.ɵfac = function VgHlsDirective_Factory(t) { return new (t || VgHlsDirective)(i0.ɵɵdirectiveInject(i0.ElementRef), i0.ɵɵdirectiveInject(i1.VgApiService)); };
/** @nocollapse */ /** @nocollapse */ VgHlsDirective.ɵdir = /** @pureOrBreakMyCode */ i0.ɵɵdefineDirective({ type: VgHlsDirective, selectors: [["", "vgHls", ""]], inputs: { vgHls: "vgHls", vgHlsHeaders: "vgHlsHeaders" }, outputs: { onGetBitrates: "onGetBitrates" }, exportAs: ["vgHls"], features: [i0.ɵɵNgOnChangesFeature] });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(VgHlsDirective, [{
        type: Directive,
        args: [{
                selector: '[vgHls]',
                exportAs: 'vgHls',
            }]
    }], function () { return [{ type: i0.ElementRef }, { type: i1.VgApiService }]; }, { vgHls: [{
            type: Input
        }], vgHlsHeaders: [{
            type: Input
        }], onGetBitrates: [{
            type: Output
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmctaGxzLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4LXZpZGVvZ3VsYXIvc3RyZWFtaW5nL3NyYy9saWIvZGlyZWN0aXZlcy92Zy1obHMvdmctaGxzLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUlULEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLFVBQVUsR0FFWCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBR0wsWUFBWSxHQUNiLE1BQU0saUNBQWlDLENBQUM7OztBQVl6QyxNQUFNLE9BQU8sY0FBYztJQWV6QixZQUFvQixHQUFlLEVBQVMsR0FBaUI7UUFBekMsUUFBRyxHQUFILEdBQUcsQ0FBWTtRQUFTLFFBQUcsR0FBSCxHQUFHLENBQWM7UUFicEQsaUJBQVksR0FBOEIsRUFBRSxDQUFDO1FBRTVDLGtCQUFhLEdBQW1DLElBQUksWUFBWSxFQUFFLENBQUM7UUFTN0Usa0JBQWEsR0FBbUIsRUFBRSxDQUFDO0lBRTZCLENBQUM7SUFFakUsUUFBUTtRQUNOLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUU7WUFDMUIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3RCO2FBQU07WUFDTCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FDckIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQ2hFLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRCxhQUFhO1FBQ1gsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDdEUsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFB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Q0FBQztnQkFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3hCLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO2FBQ3pDO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsVUFBVSxDQUFDLE9BQXVCO1FBQ2hDLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNaLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1NBQy9DO0lBQ0gsQ0FBQztJQUVELGFBQWE7UUFDWCxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDWixJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ25CLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDO1NBQ2pCO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNsQixDQUFDOztrSEFuS1UsY0FBYzttSEFBZCxjQUFjO3VGQUFkLGNBQWM7Y0FKMUIsU0FBUztlQUFDO2dCQUNULFFBQVEsRUFBRSxTQUFTO2dCQUNuQixRQUFRLEVBQUUsT0FBTzthQUNsQjt3RkFFVSxLQUFLO2tCQUFiLEtBQUs7WUFDRyxZQUFZO2tCQUFwQixLQUFLO1lBRUksYUFBYTtrQkFBdEIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgT25Jbml0LFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBFbGVtZW50UmVmLFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgSUhMU0NvbmZpZyxcbiAgQml0cmF0ZU9wdGlvbnMsXG4gIFZnQXBpU2VydmljZSxcbn0gZnJvbSAnQHZpZGVvZ3VsYXIvbmd4LXZpZGVvZ3VsYXIvY29yZSc7XG5cbmRlY2xhcmUgbGV0IEhsczoge1xuICBuZXcgKGFyZzA6IElITFNDb25maWcpOiBhbnk7XG4gIGlzU3VwcG9ydGVkOiAoKSA9PiBhbnk7XG4gIEV2ZW50czogeyBNQU5JRkVTVF9QQVJTRUQ6IGFueTsgTEVWRUxfTE9BREVEOiBhbnkgfTtcbn07XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1t2Z0hsc10nLFxuICBleHBvcnRBczogJ3ZnSGxzJyxcbn0pXG5leHBvcnQgY2xhc3MgVmdIbHNEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgQElucHV0KCkgdmdIbHM6IHN0cmluZztcbiAgQElucHV0KCkgdmdIbHNIZWFkZXJzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG5cbiAgQE91dHB1dCgpIG9uR2V0Qml0cmF0ZXM6IEV2ZW50RW1pdHRlcjxCaXRyYXRlT3B0aW9uc1tdPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICB2Z0Zvcjogc3RyaW5nO1xuICB0YXJnZXQ6IGFueTtcbiAgaGxzOiBhbnk7XG4gIHByZWxvYWQ6IGJvb2xlYW47XG4gIGNyb3Nzb3JpZ2luOiBzdHJpbmc7XG4gIGNvbmZpZzogSUhMU0NvbmZpZztcblxuICBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVmOiBFbGVtZW50UmVmLCBwdWJsaWMgQVBJOiBWZ0FwaVNlcnZpY2UpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKHRoaXMuQVBJLmlzUGxheWVyUmVhZHkpIHtcbiAgICAgIHRoaXMub25QbGF5ZXJSZWFkeSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICAgdGhpcy5BUEkucGxheWVyUmVhZHlFdmVudC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5vblBsYXllclJlYWR5KCkpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG9uUGxheWVyUmVhZHkoKSB7XG4gICAgdGhpcy5jcm9zc29yaWdpbiA9IHRoaXMucmVmLm5hdGl2ZUVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjcm9zc29yaWdpbicpO1xuICAgIHRoaXMucHJlbG9hZCA9IHRoaXMucmVmLm5hdGl2ZUVsZW1lbnQuZ2V0QXR0cmlidXRlKCdwcmVsb2FkJykgIT09ICdub25lJztcbiAgICB0aGlzLnZnRm9yID0gdGhpcy5yZWYubmF0aXZlRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3ZnRm9yJyk7XG5cbiAgICBpZiAodGhpcy52Z0Zvcikge1xuICAgICAgdGhpcy50YXJnZXQgPSB0aGlzLkFQSS5nZXRNZWRpYUJ5SWQodGhpcy52Z0Zvcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGFyZ2V0ID0gdGhpcy5BUEkuZ2V0RGVmYXVsdE1lZGlhKCk7XG4gICAgfVxuXG4gICAgdGhpcy5jb25maWcgPSB7XG4gICAgICBhdXRvU3RhcnRMb2FkOiB0aGlzLnByZWxvYWQsXG4gICAgfSBhcyBJSExTQ29uZmlnO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICB0aGlzLmNvbmZpZy54aHJTZXR1cCA9ICh4aHI6IHtcbiAgICAgIHdpdGhDcmVkZW50aWFsczogYm9vbGVhbjtcbiAgICAgIHNldFJlcXVlc3RIZWFkZXI6IChhcmcwOiBzdHJpbmcsIGFyZzE6IHN0cmluZykgPT4gdm9pZDtcbiAgICB9KSA9PiB7XG4gICAgICAvLyBTZW5kIGNvb2tpZXNcbiAgICAgIGlmICh0aGlzLmNyb3Nzb3JpZ2luID09PSAndXNlLWNyZWRlbnRpYWxzJykge1xuICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHRoaXMudmdIbHNIZWFkZXJzKSkge1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHRoaXMudmdIbHNIZWFkZXJzW2tleV0pO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLmNyZWF0ZVBsYXllcigpO1xuXG4gICAgaWYgKCF0aGlzLnByZWxvYWQpIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKFxuICAgICAgICB0aGlzLkFQSS5zdWJzY3JpcHRpb25zLnBsYXkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5obHMpIHtcbiAgICAgICAgICAgIHRoaXMuaGxzLnN0YXJ0TG9hZCgwKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy52Z0hscz8uY3VycmVudFZhbHVlKSB7XG4gICAgICB0aGlzLmNyZWF0ZVBsYXllcigpO1xuICAgIH0gZWxzZSBpZiAoY2hhbmdlcy52Z0hsc0hlYWRlcnMgJiYgY2hhbmdlcy52Z0hsc0hlYWRlcnMuY3VycmVudFZhbHVlKSB7XG4gICAgICAvLyBEbyBub3RoaW5nLiBXZSBkb24ndCB3YW50IHRvIGNyZWF0ZSBhIG9yIGRlc3Ryb3kgYSBwbGF5ZXIgaWYgdGhlIGhlYWRlcnMgY2hhbmdlLlxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRlc3Ryb3lQbGF5ZXIoKTtcbiAgICB9XG4gIH1cblxuICBjcmVhdGVQbGF5ZXIoKSB7XG4gICAgaWYgKHRoaXMuaGxzKSB7XG4gICAgICB0aGlzLmRlc3Ryb3lQbGF5ZXIoKTtcbiAgICB9XG5cbiAgICAvLyBJdCdzIGEgSExTIHNvdXJjZVxuICAgIGlmIChcbiAgICAgIHRoaXMudmdIbHMgJiZcbiAgICAgIHRoaXMudmdIbHMuaW5kZXhPZignbTN1OCcpID4gLTEgJiZcbiAgICAgIEhscy5pc1N1cHBvcnRlZCgpICYmXG4gICAgICB0aGlzLkFQSS5pc1BsYXllclJlYWR5XG4gICAgKSB7XG4gICAgICBjb25zdCB2aWRlbzogSFRNTFZpZGVvRWxlbWVudCA9IHRoaXMucmVmLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICAgIHRoaXMuaGxzID0gbmV3IEhscyh0aGlzLmNvbmZpZyk7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICB0aGlzLmhscy5vbihcbiAgICAgICAgSGxzLkV2ZW50cy5NQU5JRkVTVF9QQVJTRUQsXG4gICAgICAgIChfZXZlbnQ6IGFueSwgZGF0YTogeyBsZXZlbHM6IGFueVtdIH0pID0+IHtcbiAgICAgICAgICBjb25zdCB2aWRlb0xpc3QgPSBbXTtcblxuICAgICAgICAgIHZpZGVvTGlzdC5wdXNoKHtcbiAgICAgICAgICAgIHF1YWxpdHlJbmRleDogMCxcbiAgICAgICAgICAgIHdpZHRoOiAwLFxuICAgICAgICAgICAgaGVpZ2h0OiAwLFxuICAgICAgICAgICAgYml0cmF0ZTogMCxcbiAgICAgICAgICAgIG1lZGlhVHlwZTogJ3ZpZGVvJyxcbiAgICAgICAgICAgIGxhYmVsOiAnQVVUTycsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBkYXRhLmxldmVscy5mb3JFYWNoKFxuICAgICAgICAgICAgKFxuICAgICAgICAgICAgICBpdGVtOiB7IHdpZHRoOiBhbnk7IGhlaWdodDogYW55OyBiaXRyYXRlOiBhbnk7IG5hbWU6IGFueSB9LFxuICAgICAgICAgICAgICBpbmRleDogbnVtYmVyXG4gICAgICAgICAgICApID0+IHtcbiAgICAgICAgICAgICAgdmlkZW9MaXN0LnB1c2goe1xuICAgICAgICAgICAgICAgIHF1YWxpdHlJbmRleDogKytpbmRleCxcbiAgICAgICAgICAgICAgICB3aWR0aDogaXRlbS53aWR0aCxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IGl0ZW0uaGVpZ2h0LFxuICAgICAgICAgICAgICAgIGJpdHJhdGU6IGl0ZW0uYml0cmF0ZSxcbiAgICAgICAgICAgICAgICBtZWRpYVR5cGU6ICd2aWRlbycsXG4gICAgICAgICAgICAgICAgbGFiZWw6IGl0ZW0ubmFtZSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcblxuICAgICAgICAgIHRoaXMub25HZXRCaXRyYXRlcy5lbWl0KHZpZGVvTGlzdCk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICB0aGlzLmhscy5vbihcbiAgICAgICAgSGxzLkV2ZW50cy5MRVZFTF9MT0FERUQsXG4gICAgICAgIChfZXZlbnQ6IGFueSwgZGF0YTogeyBkZXRhaWxzOiB7IGxpdmU6IGFueSB9IH0pID0+IHtcbiAgICAgICAgICB0aGlzLnRhcmdldC5pc0xpdmUgPSBkYXRhLmRldGFpbHMubGl2ZTtcbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgdGhpcy5obHMubG9hZFNvdXJjZSh0aGlzLnZnSGxzKTtcbiAgICAgIHRoaXMuaGxzLmF0dGFjaE1lZGlhKHZpZGVvKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMudGFyZ2V0ICYmICEhdGhpcy50YXJnZXQucGF1c2UpIHtcbiAgICAgICAgdGhpcy50YXJnZXQucGF1c2UoKTtcbiAgICAgICAgdGhpcy50YXJnZXQuc2Vla1RpbWUoMCk7XG4gICAgICAgIHRoaXMucmVmLm5hdGl2ZUVsZW1lbnQuc3JjID0gdGhpcy52Z0hscztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXRCaXRyYXRlKGJpdHJhdGU6IEJpdHJhdGVPcHRpb25zKSB7XG4gICAgaWYgKHRoaXMuaGxzKSB7XG4gICAgICB0aGlzLmhscy5uZXh0TGV2ZWwgPSBiaXRyYXRlLnF1YWxpdHlJbmRleCAtIDE7XG4gICAgfVxuICB9XG5cbiAgZGVzdHJveVBsYXllcigpIHtcbiAgICBpZiAodGhpcy5obHMpIHtcbiAgICAgIHRoaXMuaGxzLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuaGxzID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaCgocykgPT4gcy51bnN1YnNjcmliZSgpKTtcbiAgICB0aGlzLmRlc3Ryb3lQbGF5ZXIoKTtcbiAgICBkZWxldGUgdGhpcy5obHM7XG4gIH1cbn1cbiJdfQ==